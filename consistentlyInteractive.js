  function getConsistentlyInteractive(networkRequests, longTasks, DOMContentLoadedEnd, currentTimeForTesting) {
    // TODO: This should be replaced by FMP.
    const searchBegin = DOMContentLoadedEnd;
    const activeRequestTolerance = 2;
    const currentTime = currentTimeForTesting || performance.now();
    const interactiveWindowSizeMs = 5000;

    const longTasksInWindow = longTasks.filter(task =>
        searchBegin <= task[1]);
    const requestsInSearchSpace = networkRequests.filter(req =>
        searchBegin <= req[1]);

    // timestamps of interest
    const endpoints = [];

    for (const task of longTasksInWindow) {
      endpoints.push({
        time: task[0],
        type: "taskStart",
        slice: task
      });
      endpoints.push({
        time: task[1],
        type: "taskEnd",
        slice: task
      });
    };

    for (const req of requestsInSearchSpace) {
      endpoints.push({
        time: req[0],
        type: "requestStart",
        slice: req
      });
      endpoints.push({
        time: req[1],
        type: "requestEnd",
        slice: req
      });
    }

    endpoints.sort((a, b) => a.time - b.time);

    let quietWindowStart = searchBegin;
    let activeNetworkRequests = 0;
    let lastCandidate = searchBegin;

    console.log("In method long tasks in window", longTasksInWindow);
    console.log("In method reqeustInSearchSpace", requestsInSearchSpace);

    for (const timestamp of endpoints) {
      switch(timestamp.type) {
        case "taskStart":
          if (timestamp.time - quietWindowStart >= interactiveWindowSizeMs &&
              activeNetworkRequests <= activeRequestTolerance) {
            return lastCandidate;
          }
          quietWindowStart = Math.max(quietWindowStart, timestamp.slice[1]);
          break;
        case "taskEnd":
          lastCandidate = timestamp.time;
          break;
        case "requestStart":
          activeNetworkRequests++;
          break;
        case "requestEnd":
          // First check if we just exited a period of network business.
          if (activeNetworkRequests > activeRequestTolerance) {
            quietWindowStart = Math.max(quietWindowStart, timestamp.time);
          }
          activeNetworkRequests--;
          break;
      }
    }

    if (currentTime - quietWindowStart >= interactiveWindowSizeMs &&
        activeNetworkRequests <= activeRequestTolerance) {
      return lastCandidate;
    }

    return null;
  }


function testConsistentlyInteractive() {
  console.log("Testing consistentlyInteractive");

  const longTasks = [[9731.08999991417,9785.13699991417],[9791.692999839783,9851.228999839783],[9855.43499994278,9910.19599994278],[14018.361999988556,14106.290999988556],[14107.975999832153,14158.357999832153],[14161.179999828339,14213.707999828339],[14223.33799982071,14278.38199982071],[19661.067999839783,19729.34899983978],[19908.81299996376,20018.89599996376]];

  const networkRequests = [[2990.2249999046326,2990.2679999046327],[2990.3629999160767,2990.401999916077],[2990.479999780655,2990.510999780655],[2990.5899999141693,2990.622999914169],[2990.686999797821,2990.722999797821],[2990.784999847412,2990.8169998474123],[2990.941999912262,2990.972999912262],[2991.106999874115,2991.137999874115],[2991.263000011444,2991.291000011444],[2868.412999868393,3065.366999868393],[2816.369999885559,3127.770999885559],[2944.7839999198914,3222.175999919891],[2944.536999940872,3393.089999940872],[2848.704999923706,3532.986999923706],[2849.7649998664856,3564.9989998664855],[3565.5920000076294,3565.7060000076294],[2986.4329998493195,3721.2559998493193],[3721.9900000095367,3722.0830000095366],[2986.5869998931885,3769.8259998931885],[3770.3899998664856,3770.4939998664854],[2980.361999988556,3924.508999988556],[2986.71799993515,4017.6359999351503],[4018.2170000076294,4018.3080000076293],[2986.832999944687,4064.717999944687],[4065.315999984741,4065.393999984741],[2986.944999933243,4189.020999933243],[4189.842000007629,4189.92900000763],[2987.0599999427795,4206.527999942779],[4207.102999925613,4207.193999925614],[2987.160999774933,4345.228999774933],[2987.2779998779297,4470.46499987793],[2987.3869998455048,4502.417999845505],[4691.43799996376,4691.50299996376],[4691.6829998493195,4691.73699984932],[4695.821999788284,4695.853999788284],[4695.865000009537,4695.882000009537],[4695.890999794006,4695.905999794007],[4695.914999961853,4695.940999961853],[4695.956999778748,4695.974999778748],[4695.984999895096,4696.004999895096],[4696.014999866486,4696.029999866486],[4696.037999868393,4696.053999868393],[4696.06299996376,4696.077999963761],[4705.830999851227,4705.870999851227],[4705.96799993515,4706.00399993515],[4706.093999862671,4706.122999862671],[4706.255999803543,4706.286999803543],[4706.3659999370575,4706.395999937057],[4706.455999851227,4706.485999851227],[4706.536999940872,4706.572999940872],[2998.707999944687,4708.296999944687],[4727.004999876022,4727.091999876023],[4727.2699999809265,4727.322999980926],[4727.479999780655,4727.5179997806545],[4727.629999876022,4727.666999876023],[4727.753999948502,4727.794999948502],[4727.886999845505,4727.920999845504],[4728.020999908447,4728.054999908447],[4728.159999847412,4728.193999847412],[4728.290999889374,4728.324999889373],[4728.459999799728,4728.5049997997285],[4750.234999895096,4750.313999895096],[2998.367999792099,4767.732999792099],[2999.0289998054504,4972.51999980545],[4696.133999824524,5002.350999824524],[5040.505999803543,5040.584999803543],[5040.748999834061,5040.803999834061],[5040.944999933243,5041.000999933242],[5041.089999914169,5041.137999914169],[5041.218999862671,5041.263999862671],[5041.415999889374,5041.461999889374],[5041.546000003815,5041.593000003814],[5041.6859998703,5041.731999870301],[5041.871999979019,5041.92299997902],[5053.2919998168945,5053.395999816895],[5053.674999952316,5053.740999952316],[5053.988999843597,5054.0519998435975],[5054.337999820709,5054.3749998207095],[5054.464999914169,5054.494999914169],[5054.563999891281,5054.595999891281],[5054.672999858856,5054.701999858857],[5054.774999856949,5054.811999856949],[5054.879999876022,5054.9119998760225],[5054.9909999370575,5055.018999937058],[4690.4349999427795,5206.035999942779],[4690.140999794006,5267.977999794006],[4694.112999916077,5501.930999916077],[2997.428999900818,5518.001999900818],[4694.265999794006,5580.277999794006],[4694.40099978447,5767.734999784469],[4694.524999856949,5814.463999856949],[4694.662999868393,5876.547999868393],[4694.77999997139,5956.50399997139],[4694.891999959946,6096.624999959946],[6541.256999969482,6541.3109999694825],[1530.2239999771118,6542.0749999771115],[6554.862999916077,6554.901999916076],[6590.660999774933,6590.722999774933],[6590.763000011444,6590.791000011444],[6590.816999912262,6590.845999912262],[6590.867999792099,6590.889999792099],[6591.9169998168945,6591.970999816895],[6592.06299996376,6592.09699996376],[6592.186999797821,6592.2159997978215],[6592.322999954224,6592.3669999542235],[6592.469999790192,6592.507999790191],[6592.571999788284,6592.611999788284],[6592.672999858856,6592.703999858856],[6623.475999832153,6623.5169998321535],[6623.656999826431,6623.685999826432],[6623.826999902725,6623.853999902725],[6623.973999977112,6624.001999977112],[6624.089999914169,6624.11899991417],[4695.695999860764,6624.469999860764],[6626.579999923706,6626.622999923706],[2853.75,6671.284],[4697.24799990654,6985.98799990654],[4697.101999998093,7033.022999998093],[6628.727999925613,7455.447999925614],[4697.354999780655,7564.150999780655],[4697.706999778748,7908.235999778748],[4697.46799993515,8049.03699993515],[4697.813999891281,8111.521999891282],[4698.606999874115,8393.171999874115],[4697.596999883652,8423.253999883651],[4697.940999984741,8502.160999984742],[4698.046000003815,8548.257000003814],[4698.735999822617,8626.998999822616],[4704.158999919891,8736.77999991989],[4704.300999879837,9283.154999879836],[2978.380999803543,9689.993999803544],[9851.09399986267,9851.131999862671],[4704.543999910355,9851.486999910354],[9911.125,9911.184],[9957.444999933243,9957.501999933243],[4704.406999826431,10034.47299982643],[4704.768999814987,10095.199999814988],[6535.748999834061,10377.627999834061],[6536.071999788284,10658.579999788284],[6536.2919998168945,10940.254999816894],[4704.885999917984,11158.304999917984],[6536.5,11220.951000000001],[5005.063999891281,11317.315999891282],[4705.046000003815,11533.220000003814],[4704.640999794006,13189.192999794006],[2979.4900000095367,14018.112000009536],[6538.770999908447,14106.541999908448],[14235.694000005722,14235.779000005721],[14278.131999969482,14278.167999969482],[14278.178999900818,14278.198999900818],[14278.204999923706,14278.222999923706],[6538.104999780655,14279.691999780654],[6538.350999832153,14303.329999832153],[14155.4359998703,14347.4629998703],[6540.828999996185,14596.092999996185],[6541.070999860764,14680.914999860765],[14308.132999897003,14705.515999897003],[6538.567999839783,14767.183999839783],[6538.948999881744,14799.086999881745],[6554.9169998168945,14907.547999816894],[6589.507999897003,15064.805999897004],[6588.7519998550415,15095.912999855042],[6553.284999847412,15142.501999847413],[6589.993999958038,15163.732999958038],[15245.389999866486,15456.351999866485],[6539.303999900818,15502.785999900818],[6602.536999940872,15595.919999940872],[6602.243999958038,15610.889999958039],[6601.964999914169,15705.30499991417],[6603.039999961853,15833.170999961852],[6602.8109998703,15833.4269998703],[6603.503999948502,15926.030999948502],[6603.281999826431,16048.241999826432],[6603.735999822617,16298.656999822617],[9864.865999937057,16331.050999937059],[9850.865000009537,16377.144000009537],[6603.96799993515,16391.72199993515],[9908.761999845505,16502.222999845504],[6629.226999998093,16534.390999998093],[9908.913999795914,16579.684999795914],[9909.023999929428,16642.227999929426],[9909.146999835968,16658.093999835968],[9909.244999885559,16737.09899988556],[9909.350999832153,16892.73499983215],[9909.585999965668,16908.066999965667],[9909.460999965668,16924.34199996567],[9909.801999807358,17001.944999807358],[9909.68799996376,17018.11899996376],[16342.270999908447,17206.125999908447],[17211.84399986267,17211.921999862672],[17212.049999952316,17212.084999952316],[17212.194000005722,17212.22700000572],[17212.323999881744,17212.355999881744],[17212.460999965668,17212.492999965667],[17212.583999872208,17212.62799987221],[17212.72199988365,17212.762999883653],[17212.87099981308,17212.90299981308],[17213.00199985504,17213.03199985504],[17213.12599992752,17213.15899992752],[9935.584999799728,17257.55399979973],[17259.070999860764,17259.138999860763],[9962.013000011444,17611.437000011443],[17616.36699986458,17616.45699986458],[14209.96599984169,17644.10699984169],[14277.6859998703,17659.3669998703],[14277.87599992752,17720.15499992752],[17213.947999954224,17752.052999954223],[6539.130999803543,17782.661999803546],[14278.003999948502,17970.5149999485],[17261.12399983406,18095.85599983406],[18101.03299999237,18101.181999992372],[17241.763999938965,18142.592999938966],[17627.09699988365,18205.692999883653],[18207.885999917984,18208.010999917984],[18218.447999954224,18218.530999954222],[18111.46399998665,18377.242999986647],[18382.30799984932,18382.42999984932],[18391.171000003815,18391.247000003816],[18398.827999830246,18783.034999830244],[18788.009999990463,18788.133999990463],[18220.81299996376,18876.75099996376],[18882.585999965668,18882.742999965667],[18796.953999996185,19205.223999996186],[19210.21799993515,19210.34599993515],[18894.1289999485,19282.707999948503],[19287.722999811172,19287.847999811172],[19221.689999818802,19548.588999818803],[19553.40899991989,19553.49899991989],[17217.115999937057,19626.912999937056],[19297.805999994278,19733.65099999428],[19743.46299982071,19743.51899982071],[19562.49799990654,19846.00799990654],[19847.615000009537,19847.71300000954],[19854.671999931335,19854.719999931334],[19859.130999803543,19859.204999803544],[19728.886999845505,19862.965999845506],[19864.24899983406,19864.33899983406],[19868.65699982643,19868.72599982643],[19740.1819999218,19908.603999921797],[19750.706999778748,20019.62499977875],[20023.483999967575,20023.525999967576],[19873.27899980545,20111.340999805452],[20113.227999925613,20113.330999925613],[20015.78199982643,20174.499999826432],[20175.265999794006,20175.351999794006],[20025.142999887466,20642.546999887465],[20647.514999866486,20647.640999866486],[20122.1859998703,20736.4769998703],[20741.327999830246,20741.444999830244],[20655.895999908447,20877.336999908446],[20917.81299996376,20917.86899996376],[20888.827999830246,21019.164999830246],[20889.206999778748,21034.85299977875],[20889.49799990654,21096.86399990654],[20910.90899991989,21174.022999919893],[20890.34599995613,21192.333999956132],[21058.551999807358,21214.39899980736],[21190.43299984932,21317.961999849318],[21202.391999959946,21349.142999959946],[21202.56399989128,21362.89899989128],[21202.698999881744,21393.581999881746],[21202.84200000763,21409.68500000763],[21058.33699989319,21454.581999893187],[21463.008999824524,21463.131999824524],[21319.6289999485,21472.8419999485],[21207,21603.228],[21607.234999895096,21727.768999895095],[21733.18399977684,21733.24999977684],[21733.298999786377,21733.354999786377],[21733.389999866486,21733.432999866487],[21733.47099995613,21733.51599995613],[21733.607999801636,21733.670999801634],[21733.71199989319,21733.76499989319],[21733.788999795914,21733.813999795915],[21733.832999944687,21733.863999944686],[21733.884999990463,21733.909999990465],[21733.928999900818,21733.957999900817],[21733.976999998093,21733.999999998094],[21734.019999980927,21734.043999980928],[21734.06199979782,21734.084999797822],[21734.110999822617,21734.135999822618],[21734.15599989891,21734.17999989891],[21734.200999975204,21734.224999975206],[21734.24499988556,21734.272999885558],[21730.235999822617,22055.537999822616],[21729.538999795914,22080.284999795913],[21730.64999985695,22158.444999856947],[21729.793999910355,22175.172999910355],[21730.009999990463,22189.747999990464],[21730.46199989319,22206.131999893187],[21731.24199986458,22221.429999864577],[21731.043999910355,22237.756999910354],[21730.854999780655,22268.562999780654],[21731.43899989128,22315.43699989128],[22047.011999845505,22361.689999845505],[21731.805999994278,22393.14799999428],[21731.625,22455.46],[22412.754999876022,22534.26399987602],[21732.409999847412,22596.19199984741],[21731.99599981308,22611.72799981308],[21732.20999979973,22675.203999799727],[21732.84499979019,22705.80999979019],[22420.40099978447,22721.20099978447],[22420.58799982071,22766.98099982071],[22420.228999853134,22783.722999853133],[22420.96599984169,22860.69999984169],[22422.77799987793,23017.36999987793],[23019.428999900818,23019.53899990082],[22426.95999979973,23033.74699979973],[23035.28199982643,23035.35099982643],[21732.603999853134,23059.323999853135],[23058.770999908447,23221.97599990845],[23027.885999917984,23314.508999917984],[23319.421000003815,23319.549000003815],[23036.8109998703,23392.4629998703],[23394.106999874115,23394.196999874115],[22420.754999876022,23533.847999876023],[23327.918999910355,23626.729999910356],[23631.570999860764,23631.670999860762],[23399.02899980545,23704.60599980545],[23706.383999824524,23706.469999824523],[23639.256999969482,23907.93199996948],[23913.352999925613,23913.500999925614],[23708.255999803543,23955.737999803543],[23957.689999818802,23957.7959998188],[23923.610999822617,24143.041999822617],[24147.68499994278,24147.74999994278],[23965.513999938965,24220.463999938966],[24228.064999818802,24228.177999818803],[24053.881999969482,24330.76799996948],[24236.486999988556,24393.265999988555],[24052.74199986458,25236.990999864578]];

  const dcl = 6651.880999803543;
  const mockCurrentTime = networkRequests[networkRequests.length - 1][1] + 10000;
  const firstInteractive = getConsistentlyInteractive(networkRequests, longTasks, dcl, mockCurrentTime);
  console.log("mockCurrentTime", mockCurrentTime);
  console.log("FirstInteractive", firstInteractive);

  console.assert(Math.abs(firstInteractive - 20018.89599996376) <= 1e-7);
  console.log("Test passed");
}

testConsistentlyInteractive();
